---
title: "Reimplement matching"
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(aws.s3)
library(terra)
library(tictoc)
library(stars)
library(rgee)
library(tmap)
library(geojsonio)
setwd("replication_report")
```


We use the R package `rgee` as an interface to Google Earth engine API.
Instead of separate rasters, we merge all the data as stacked bands of the same raster.

```{r}
# Authenticate if needed
# ee_Authenticate()
# ee_clean_user_credentials('ndef')

# Setup ------------------------------------------------------------------------
ee_Initialize(user = "my_name", drive = TRUE) # change ndef with 'toto'
scale <- 0.008983153 # From Wolf et al. 2021

# Hansen/GFC -------------------------------------------------------------------

gfc <- ee$Image("UMD/hansen/global_forest_change_2021_v1_9")

## Lossyear ------------------------------------
lossyear <- gfc$select("lossyear") 
lossyear <- lossyear$updateMask(lossyear$neq(0)) # maskout 0
lossyear <- lossyear$reduceResolution(
  reducer = ee$Reducer$mode(), bestEffort = TRUE)
lossyear <- lossyear$toInt()
# ee_print(lossyear)

## Cover ----------------------------------------
# On datamask, 0=no data, 1=land, 2=water. We keep land.
cover_mask <- gfc$select("datamask")$eq(1)
gfc <- gfc$updateMask(cover_mask)
cover <- gfc$select("treecover2000")
cover <- cover$reduceResolution(reducer = ee$Reducer$mean(), bestEffort = TRUE)
cover <- cover$toInt()
# ee_print(cover)

# Other rasters fetched from GEE by wold et al. --------------------------------
elev <- ee$Image("USGS/GTOPO30")
travel_time <- ee$Image("Oxford/MAP/accessibility_to_cities_2015_v1_0")
gpw <- paste0("CIESIN/GPWv411/GPW_UNWPP-Adjusted_Population_Density/",
              "gpw_v4_population_density_adjusted_to_2015", 
              "unwpp_country_totals_rev11_2000_30_sec")
pop_dens <- ee$Image(gpw)$
  select("unwpp-adjusted_population_density")$
  focal_mean(radius = 20e3, kernelType = "circle", units = "meters")$
  toInt()

combined_bands <- cover$addBands(lossyear, elev, travel_time, pop_dens)
combined_bands <- combined_bands$rename(c("cover", "lossyear", "elev",
                                          "travel_time", "pop_dens"))

# Launch the GEE task and transfer the output locally --------------------------
gee_task <- ee_as_raster(image = combined_bands, 
                         crsTransform = paste(scale, 0, -180, 0, 
                                              -scale, 90, sep = ", "),
                         crs = "EPSG:4326",
                         dimensions = paste(as.character(round(360/scale)), "x", 
                                            as.character(round(360/scale))),
                        container = "rgee_new",
                        maxPixels = 1e12)

ee_drive_to_local(ee_id = gee_task, dsn = "data_input/combined.tif")

```


```{r}
# Fetch other data

drivers
ecoregions
country

# Stack as layers in the general raster


# Convert the raster as dataframe
```


```{r}

processed_rasters <- get_bucket_df(
  bucket = "fbedecarrats",
  prefix = "Replication_wolf/data_processed/rasters",
  region = "") %>%
  pluck("Key")

# A function to iterate/vectorize copy
save_from_s3 <- function(x, y) {
  aws.s3::save_object(
    object = x,
    bucket = "fbedecarrats",
    file = y,
    overwrite = TRUE,
    region = "")
  }

dest_processed <- str_remove(processed_rasters, "Replication_wolf/")
name_layers <- str_remove(dest_processed, "data_processed/rasters/")
name_layers <- str_remove(name_layers, ".tif")

```

Copy files

```{r}
map2(processed_rasters, dest_processed, save_from_s3)
```

Try with Terra

```{r}
gee_rast <- rast(dest_processed[1:8])
names(gee_rast) <- name_layers[1:8]


tm_shape(gee_rast) +
  tm_raster("PAs")
  
writeRaster(gee_rast, "temp/gee_rast.tif", overwrite = TRUE)
```

Try with stars

```{r}
gee_stars <- read_stars(dest_processed)
str(gee_stars)

write_stars(gee_stars, "temp/gee_stars.tif")
class(gee_stars)
```
