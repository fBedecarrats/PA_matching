---
title: "Reimplement matching"
editor: visual
editor_options: 
  chunk_output_type: console
---


We use the R package `rgee` as an interface to Google Earth engine API.

```{r}
# Sometime rgee does not find the right python env, so we specify it
reticulate::use_python("C:/Users/fbede/AppData/Local/r-miniconda/envs/rgee")
library(rgee) # accesses GEE through its python API
# Install rgeeExtra if not present
if (!("rgeeExtra" %in% installed.packages())) {
  remotes::install_github("r-earthengine/rgeeExtra")
}
library(rgeeExtra) # additional funcitonnalities
library(googledrive) # to download additional data from drive (facultative)
library(tidyverse)
ee_Initialize()
```

We want to use the same data as Wolf et al. but to implement a different strategy that:   

- implies less manipulations steps that might be error prone;
- relies on cloud data processing for very big datasets;
- only relies on one language and configuration for local processing.

Therefore we plan to leverage Google Earth engine to the maximum by: 

- using the same data sources and processing than Wolf et al,;
- add the other data that were obtained from different data sources;
- better mask the data to reduce its size;
- stack all the information in single multi-bands rasters;
- slice the rasters by country and biome as these are matched separately;
- download individual rasters to match them locally;
- store the matched data into an efficient on-disk storage for later processing;
- do the final regressions leveraging bigger than memory funcitonnalities of R.

# Load Biomes on Google Earth Engine and use them as masks

First we will fetch the biome descriptions from the resolve ecoregions.

```{r}
ecoregions <- ee$FeatureCollection("RESOLVE/ECOREGIONS/2017")
Map$addLayer(ecoregions)

biome_names <- ecoregions$
  reduceColumns(ee$Reducer$toList(), list("BIOME_NAME"))$
  get("list")$
  getInfo()
print(unique(biome_names))
```
```
 [1] "Tropical & Subtropical Moist Broadleaf Forests"          
 [2] "Tropical & Subtropical Grasslands, Savannas & Shrublands"
 [3] "Flooded Grasslands & Savannas"                           
 [4] "Montane Grasslands & Shrublands"                         
 [5] "Deserts & Xeric Shrublands"                              
 [6] "Mangroves"                                               
 [7] "Mediterranean Forests, Woodlands & Scrub"                
 [8] "Tropical & Subtropical Dry Broadleaf Forests"            
 [9] "Tropical & Subtropical Coniferous Forests"               
[10] "Temperate Broadleaf & Mixed Forests"                     
[11] "Temperate Conifer Forests"                               
[12] "Temperate Grasslands, Savannas & Shrublands"             
[13] "N/A"                                                     
[14] "Boreal Forests/Taiga"                                    
[15] "Tundra"  
```
Wolf et al. specify that they focused on the following ones:   

- Tropical & Subtropical Moist Broadleaf Forests
- Tropical & Subtropical Dry Broadleaf Forests
- Tropical & Subtropical Coniferous Forests
- Temperate Broadleaf & 74 Mixed Forests
- Temperate Conifer Forests
- Boreal Forests/Taiga
- Mangroves

```{r}
select_ecoregs <- 
```



```{r}
library(tidyverse)
library(aws.s3)
library(tictoc)

# library(rgeeExtra)
library(tmap)

library(arrow)
library(sf)
# library(terra)
# library(stars)
# library(geojsonio)
setwd("replication_report")
```



```{r}
# Authenticate if needed
# ee_install()
library(rgee)
ee_Authenticate()
ee_clean_user_credentials('ndef')


# Setup ------------------------------------------------------------------------
ee_Initialize(user = "ndef", drive = TRUE) # change ndef with 'toto'
```

Instead of separate rasters, we merge all the data as stacked bands of the same raster.

```{r}
scale <- 0.008983153 # From Wolf et al. 2021
drive_folder <- "rgee"
local_folder <- "temp"

# Hansen/GFC -------------------------------------------------------------------
gfc <- ee$Image("UMD/hansen/global_forest_change_2021_v1_9")

## Lossyear ------------------------------------
lossyear <- gfc$select("lossyear")
lossyear <- lossyear$updateMask(lossyear$neq(0)) # maskout 0
lossyear <- lossyear$reduceResolution(reducer = ee$Reducer$mode(), 
                                      bestEffort = TRUE)
lossyear <- lossyear$toInt()

## Cover ----------------------------------------
# On datamask, 0=no data, 1=land, 2=water. We keep land.
mask_cover <- gfc$select("datamask")$eq(1)
cover <-  gfc$updateMask(cover_mask)
cover <- cover$select("treecover2000")
cover <- cover$reduceResolution(reducer = ee$Reducer$mean(), 
                                bestEffort = TRUE)
cover <- cover$toInt()

## Loss --------------------------------------------
loss <- gfc$select("loss")
loss <- loss$reduceResolution(reducer = ee$Reducer$mean(), bestEffort = TRUE)
loss <- loss$toInt32()

# Other rasters fetched from GEE by wold et al. --------------------------------
elev <- ee$Image("USGS/GTOPO30")
elev <- elev$toInt()
# ee_print(elev)
travel_time <- ee$Image("Oxford/MAP/accessibility_to_cities_2015_v1_0")
travel_time <- travel_time$toInt()
gpw <- paste0("CIESIN/GPWv411/GPW_UNWPP-Adjusted_Population_Density/",
              "gpw_v4_population_density_adjusted_to_2015_", 
              "unwpp_country_totals_rev11_2000_30_sec")
pop_dens <- ee$Image(gpw)
pop_dens <- pop_dens$select("unwpp-adjusted_population_density")
pop_dens <- pop_dens$focal_mean(radius = 20e3, kernelType = "circle", 
                                units = "meters")
pop_dens <- pop_dens$toInt()

# stack bands into a single raster and export ----------------------------------
combined <- cover$addBands(c(lossyear, loss, elev, travel_time, pop_dens))
combined <- combined$rename(c("cover", "lossyear", "loss", "elev",
                                          "travel_time", "pop_dens"))
# Export with the same crsTransform and dimensions than Wolf et al. (2021)
gfc_task <- ee_as_raster(image = combined,
                         crsTransform = paste(scale, 0, -180, 0, -scale, 90, sep = ", "),
                         crs = "EPSG:4326",
                         dimensions = paste(as.character(round(360/scale)), "x",
                                            as.character(round(360/scale))),
                         container = "rgee3",
                         maxPixels = 1e12,
                         dsn = "data_input/stacked.tif")
```

# Load assets to GEE

```{r}

# Countries




# Biomes



# Compare with source used by Wolf et al. --------------------------------------

## Download
wwf_url <- paste0("https://files.worldwildlife.org/wwfcmsprod/files/",
                  "Publication/file/6kcchn7e3u_official_teow.zip")
wwf_destfile <- "temp/ecoregions_wwf.zip"
download.file(url = wwf_url, destfile = wwf_destfile)
unzip(zipfile = wwf_destfile, exdir = "data_input") 

# Load
wwf_ecoregions <- st_read("data_input/official/wwf_terr_ecos.shp") %>%
  st_make_valid()

tmap_mode("plot")
wwf_ecoregions %>%
  mutate(BIOME = factor(BIOME)) %>%
  tm_shape() + 
  tm_polygons(col = "BIOME")

# Drivers

wwf_ecoregions %>%
  st_drop_geometry() %>%
  group_by(BIOME) %>%
  summarise(n_distinct = n_distinct(BIOME),
            n = n())
wwf_ecoregions %>%
  st_drop_geometry() %>%
  group_by(ECO_NAME) %>%
  summarise(n_distinct = n_distinct(ECO_NAME),
            n = n())

```



Load GEE data

```{r}
# Merge rasters received from GEE
rast_files <- list.files(path = "data_input", pattern = "stacked.*", 
                         full.names = TRUE)
rast_file_names <- list.files(path = "data_input", pattern = "stacked.*")
rast_dest <- paste0("Replication_wolf/data_input/gee/", rast_file_names)

map2(rast_files, rast_dest, ~put_object(file = .x, object = .y,
                                        bucket = "fbedecarrats",
                                        region = "",
                                        multipart = TRUE))

my_stars <- read_stars(rast_files[[1]])
my_stars
my_stars <- read_stars(c(rast_files[[1]], rast_files[[2]]), along = "band")

my_rasts <- map(rast_files, rast)
my_rast <- do.call(merge, c(my_rasts, filename = "data_input/gee/all.tif"))


my_star <- read_stars("data_input/stacked-0001.tif")

all <- read_stars("data_input/gee/all.tif")

plot(all)
my_star_df <- as.data.frame(my_star)
str(my_star_df)

my_star_df %>%
  write_parquet("data_input.parquet")
# A 2GB parquet file


my_star_df %>%
  group_by(band) %>%
  summarise(min = min(stacked.0001.tif, na.rm = TRUE),
            max = max(stacked.0001.tif, na.rm = TRUE))
# # A tibble: 6 Ã— 3
#   band          min   max
#   <fct>       <dbl> <dbl>
# 1 cover           0   100
# 2 lossyear        0    21
# 3 loss            0     1
# 4 elev          -79  6710
# 5 travel_time     0 41556
# 6 pop_dens        0 25031

rasterio <- list(nXOff = 6, nYOff = 6, nXSize = 3, nYSize = 3, bands = 3)
my_star2 <- read_stars("data_input/stacked-0001.tif")


my_rast <- rast("data_input/stacked-0007.tif")
# my_rast <- rast("data_processed/rasters/cover.tif")

my_star

tmap_options("max.raster")
tmap_options(max.raster = c(plot = 100000, view = 100000))
tmap_mode("plot")
# raster.warp = FALSE
tm_shape(my_rast) +
  tm_raster()



my_rast
small_rast <- spatSample(my_rast)


aws.s3::put_object(file = "data_input/gee_all.tif",
                  object = "data_input/gee/all.tif",
                  bucket = "fbedecarrats",
                  region = "")

aws.s3::save_object(file = "data_input/gee/all.tif",
                    object = "data_input/gee/all.tif",
                    bucket = "fbedecarrats",
                    region = "")




dir.create("data_input")
dir.create("data_input/gee")
aws.s3::put_object(file = "data_input/stacked-0001.tif",
                  object = "data_input/gee/stacked-0001.tif",
                  bucket = "fbedecarrats",
                  region = "",
                  multipart = TRUE)
aws.s3::save_object(file = "data_input/stacked-0001.tif",
                    object = "data_input/gee/stacked-0001.tif",
                    bucket = "fbedecarrats",
                    region = "",
                    multipart = TRUE)

```
